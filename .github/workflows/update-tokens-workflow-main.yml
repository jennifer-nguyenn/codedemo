name: Update Tokens from Dimension CSS

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'dimension.css/base/dimension.css'
      - 'dimension.css/index.css'
    branches:
      - main

jobs:
  update-tokens:
    runs-on: ubuntu-latest
    # Only run on PRs created by Supernova targeting main
    if: contains(github.event.pull_request.title, 'Supernova') || contains(github.event.pull_request.body, 'Supernova')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Create scripts directory if it doesn't exist
        run: mkdir -p .github/scripts
      
      - name: Create update script
        run: |
          cat > .github/scripts/update-tokens-from-css.js << 'EOL'
          const fs = require('fs');
          const path = require('path');

          // Updated paths to files - adjusted for actual Supernova paths
          const dimensionCssPath = path.join(process.cwd(), 'dimension.css', 'base', 'dimension.css');
          const tokensJsPath = path.join(process.cwd(), 'src', 'tokens.ts');

          console.log('Starting update script on main branch');
          console.log(`Dimension CSS path: ${dimensionCssPath}`);
          console.log(`Tokens TS path: ${tokensJsPath}`);

          // Function to extract dimension values from CSS
          function extractDimensionValues(cssContent) {
            const values = {};
            const pattern = /--dimension-order-info-card-mobile-width:\s*([\d.]+)px/g;
            let match;
            
            while ((match = pattern.exec(cssContent)) !== null) {
              const value = match[1];
              values['order-info-card-mobile-width'] = value;
              console.log(`Found dimension: order-info-card-mobile-width = ${value}px`);
            }
            
            return values;
          }

          // Function to update tokens.ts with only changed values
          function updateTokensFile(tokensContent, dimensionValues) {
            let updatedContent = tokensContent;
            let changesMade = false;
            
            const orderCardValue = dimensionValues['order-info-card-mobile-width'];
            if (orderCardValue) {
              console.log(`Updating orderInfoCard.mobileWidth to ${orderCardValue}px`);
              
              // Pattern to find the specific property in tokens.ts
              const pattern = /(orderInfoCard\s*:\s*{\s*mobileWidth\s*:\s*['"])([0-9.]+)(px['"])/;
              
              const match = updatedContent.match(pattern);
              if (match) {
                const oldValue = match[2];
                if (oldValue !== orderCardValue) {
                  updatedContent = updatedContent.replace(pattern, `$1${orderCardValue}$3`);
                  console.log(`Updated orderInfoCard.mobileWidth: ${oldValue}px -> ${orderCardValue}px`);
                  changesMade = true;
                } else {
                  console.log(`No change needed for orderInfoCard.mobileWidth, value already ${orderCardValue}px`);
                }
              } else {
                console.log(`Could not find pattern for orderInfoCard.mobileWidth in tokens.ts`);
              }
            }
            
            return { updatedContent, changesMade };
          }

          // Main function
          try {
            // Check if files exist
            if (!fs.existsSync(dimensionCssPath)) {
              console.error(`dimension.css file not found at ${dimensionCssPath}`);
              process.exit(1);
            }
            
            if (!fs.existsSync(tokensJsPath)) {
              console.error(`tokens.ts file not found at ${tokensJsPath}`);
              process.exit(1);
            }
            
            // Read files
            const dimensionCssContent = fs.readFileSync(dimensionCssPath, 'utf8');
            const tokensContent = fs.readFileSync(tokensJsPath, 'utf8');
            
            // Extract values from dimension.css
            const dimensionValues = extractDimensionValues(dimensionCssContent);
            
            if (Object.keys(dimensionValues).length === 0) {
              console.log('No dimension values found in CSS file');
              process.exit(0);
            }
            
            // Update tokens.ts
            const { updatedContent, changesMade } = updateTokensFile(tokensContent, dimensionValues);
            
            if (changesMade) {
              // Write updated content
              fs.writeFileSync(tokensJsPath, updatedContent);
              console.log('tokens.ts updated successfully');
            } else {
              console.log('No changes needed in tokens.ts');
            }
          } catch (error) {
            console.error('Error:', error);
            process.exit(1);
          }
          EOL

      - name: Run update script
        run: node .github/scripts/update-tokens-from-css.js
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code --quiet src/tokens.ts || echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit changes if any
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/tokens.ts
          git commit -m "Update tokens.ts based on dimension.css changes from Supernova"
          git push
